var ProfileBody = React.createClass({
    displayName: 'ProfileBody',
    getInitialState: function() {
        return {
            profile: this.props.profile,
            view: {showModal: false},
            reviews: [],
            reviewCount: 0,
            rating: 0,
            initials: ''
        };
    },
    openScoreDetails: function () {
      //  $("#modalContent").html("<div>Score details...</div>");
      //  this.setState({view: {showModal: true}});
    },
    handleHideModal(){
        this.setState({view: {showModal: false}})
    },
    componentWillMount: function () {
        console.log("ProfileBody:componentWillMount:");
        this.prepareComponentState(this.props);
    },
    componentWillReceiveProps: function (nextProps) {
        console.log("ProfileBody:componentWillReceiveProps:");
        this.prepareComponentState(nextProps);
    },
    prepareComponentState: function(props) {
        console.log("ProfileBody:prepareComponentState:");
        console.log(props);
        if (!$.isEmptyObject(props.profile) && $.isEmptyObject(this.state.profile)) {
            this.setState({
                profile: props.profile
            });
            console.log("ProfileBody:prepareComponentState:getInitials");
            // get initials
            var name = props.profile.firstName + ' ' + props.profile.lastName;
            console.log(name);
            if (name != null) {
                var initials = name.match(/\b\w/g);
                console.log(initials);
                initials = (initials.shift() + initials.pop()).toUpperCase();
                console.log(initials);
                this.setState({initials: initials});
            }
        }
        // Get reviews
        if (this.state.reviews.length == 0) {
            var profileid = $("#profileid").val();
            if (profileid != "") {
                var data = {
                    id: profileid
                }
                var formData = JSON.stringify(data, null, ' ');
                console.log("Get Reviews:")
                console.log(formData);
                $.ajax({
                    type: "POST",
                    url: "/getReviewsForUser",
                    async: true,
                    data: formData,
                    success: function (result) {
                        console.log(result)
                        if (result.page.totalElements > 0) {
                            this.setState({
                                reviews: result._embedded.reviewDTOList,
                                reviewCount: result.page.totalElements
                            });
                            this.calculateRating();
                            this.showReviews(result._embedded.reviewDTOList);
                        }
                    }.bind(this),
                    dataType: "json",
                    contentType: "application/json"
                });
            }
        }
    },
    calculateRating: function() {
        console.log("Calculate rating");
        var total = this.state.reviewCount;
        var sum = 0;
        var reviews = this.state.reviews;
        console.log(reviews);
        $.each(reviews, function(key, value) {
            if (value.overallRating != null) {
                sum = sum + value.overallRating;
            }
        })
        var rating = sum /total;
        console.log(rating);
        this.setState({
            rating: rating
        });
    },
    whyCertified: function () {
        bootbox.dialog({
            title: "Latch Certified Reviews",
            message: '<div class="bootbox-logo-middle"><img class="img-responsive" src="/images/LATCH-Logo-reviews.png" /></div><div class="text-left">LATCH Certified reviews are reviews that originated from a user on the LATCH platform. The review itself could have been manually triggered by the professional using the LATCH platform or automatically generated by the LATCH review engine itself. Reviews with this emblem are certified to be authentic and accurate.</div> '
        });
    },
    showReviews: function(review) {
        console.log("ProfileContent:ShowReviews:");
        console.log(review);
        const results = [];
        if (review.overallRating != null && review.reviewComments != "") {
            var created = new Date(review.completeTime);
            var createDate = $.datepicker.formatDate("mm/dd/yy", new Date(created));
            results.push(
                <li className="list-group-item" key={review.id}>
                    <div className="review-date">{createDate}</div>
                    <div className="review-badge"><a onClick={this.whyCertified} className="pointer"><img src="/images/LATCH-Logo-reviews.png" alt="Latch Certified" /></a></div>
                    <div className="review-stars"><ReviewStars fontSize={'20px'} rating={review.overallRating}/></div>
                    <div className="review-summary">Written by <a className="reviewer-link" href={'/profile/' + review.reviewerUserId} target="_blank">{review.reviewer.firstName} {review.reviewer.lastName}</a></div>
                    <div className="review-description">{review.reviewComments}</div>
                </li>
            );
        }
        return results;
    },
    render: function () {
        var leadParagraph = '';
        var description = '';
        if (this.state.profile.leadParagraph != null && this.state.profile.leadParagraph != "") {
            leadParagraph = this.state.profile.leadParagraph;
        }
        if (this.state.profile.description != null && this.state.profile.description != "") {
            description = this.state.profile.description;
        }
        var profileAvatar = <img className="img-circle img-user" src={'/api/remoteFiles/view/' + this.state.profile.avatar} />;
        if (this.state.profile.avatar == 'default' && this.state.initials != '') {
            profileAvatar = <div className="avatar-circle-large"><img className="hidden" id={this.state.profile.id} /><span className="initials-large">{this.state.initials}</span></div>;
        }
        return (
        <div className="row profile-row" id="home-content">
            <div className="col-lg-12">
                <div id="profile-content-row" className="row state-overview">
                    <div className="row" id="profile-content">
                        <div className="col-lg-12">
                            <div className="panel panel-default">
                                <div className="panel-heading">
                                    <header className="panel-title">
                                        <div className="profile-name"><strong>{this.state.profile.firstName}</strong> {this.state.profile.lastName}<strong>.</strong></div>
                                    </header>
                                </div>
                                <div className="panel-body">
                                    <div className="row">
                                        <div className="col-md-12">
                                            <div className="col-md-9">
                                                <div className="col-md-4 text-center" id="user">
                                                    {profileAvatar}
                                                    <p className="sosmed-user">
                                                        <a href="#"><i className="fa fa-facebook" onClick={this.openFacebook} data-toggle="tooltip" data-placement="top" title="Facebook"></i></a>
                                                        <a href="#"><i className="fa fa-twitter" data-toggle="tooltip" data-placement="top" title="Twitter"></i></a>
                                                        <a href="#"><i className="fa fa-google-plus" data-toggle="tooltip" data-placement="top" title="Google Plus"></i></a>
                                                        <a href="#"><i className="fa fa-linkedin" data-toggle="tooltip" data-placement="top" title="Linkedin"></i></a>
                                                    </p>
                                                </div>
                                                <div className="col-md-4">
                                                    <div className="profile-stars">
                                                        <div className="profile-review-stars"><ReviewStars fontSize={'26px'} rating={this.state.rating}/></div>
                                                        <div className="profile-head-title">({this.state.reviewCount} reviews)</div>
                                                    </div>
                                                    <ProfileBits profile={this.state.profile} />
                                                </div>
                                                <div className="col-md-4">
                                                    <div className="simple-map">
                                                        <MapView profile={this.state.profile} lat={this.state.profile.lat}
                                                                 lng={this.state.profile.lng} />
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="col-md-3 score-chart">
                                                <div onClick={this.openScoreDetails} id="scoreChartDiv" className="canvas-score pointer"><ScoreChart id={this.state.profile.id} /></div>
                                                <div>
                                                    <p className="score-label"><img src="/images/LATCH-Logo.png" className="Score-brandImg" />Score</p>
                                                </div>
                                            </div>
                                        </div>
                                        {this.state.view.showModal ? <RemoteModal title={'Score details'} size={''} handleHideModal={this.handleHideModal}><div id="modalContent"></div></RemoteModal> : null}
                                        <div className="col-lg-12 col-md-12 col-xs-12">
                                            <div className="tab-pane fade active in text-left" id="description">
                                                <p className="lead">{leadParagraph}</p>
                                                <p className="mainText bottom10"><span dangerouslySetInnerHTML={{__html: marked(description)}}></span></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="reviews-panel" className="col-lg-12 col-md-12 col-xs-12">
                            <div className="panel">
                                <div className="panel-body">
                                    <ul classNamne="list-group">
                                        { this.state.reviews.map(this.showReviews) }
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div className="col-lg-12 col-md-12 col-xs-12">
                            <div className="panel">
                                <div className="panel-body">
                                    <ul id="myTab" className="nav nav-pills">
                                        <li className="active"><a href="#linkedin" data-toggle="tab"><i className="fa fa-linkedin"></i><br /><div>Linked In</div></a></li>
                                        <li className=""><a href="#zillow" data-toggle="tab"><i className="fa icon-zillow"></i><br /><div>Zillow</div></a></li>
                                        <li className=""><a href="#facebook" data-toggle="tab"><i className="fa fa-facebook"></i><br /><div>Facebook</div></a></li>
                                        <li className=""><a href="#googleplus" data-toggle="tab"><i className="fa fa-google-plus"><br /></i><div>Google Plus</div></a></li>
                                        <li className=""><a href="#instagram" data-toggle="tab"><i className="fa fa-instagram"><br /></i><div>Instagram</div></a></li>
                                    </ul>
                                    <div id="myTabContent" className="tab-content">
                                        <div className="tab-pane fade active in" id="linkedin">
                                            <LinkedIn profile={this.state.profile} />
                                        </div>
                                        <div className="tab-pane fade text-left" id="zillow">
                                            <Zillow profile={this.state.profile} />
                                        </div>
                                        <div className="tab-pane fade" id="facebook">
                                            <Facebook profile={this.state.profile} />
                                        </div>
                                        <div className="tab-pane fade" id="googleplus">
                                            <GooglePlus profile={this.state.profile} />
                                        </div>
                                        <div className="tab-pane fade" id="instagram">
                                            <Instagram profile={this.state.profile} />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        );
    }
});